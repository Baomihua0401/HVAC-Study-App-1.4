document.addEventListener("DOMContentLoaded", function () {
  const nextButton = document.getElementById("next-btn");
  const backButton = document.getElementById("back-btn");
  const questionText = document.getElementById("question-text");
  const optionsContainer = document.getElementById("options");
  const explanationText = document.getElementById("explanation");
  const languageSwitch = document.getElementById("language-switch");
  const progressText = document.getElementById("progress");
  const accuracyText = document.getElementById("accuracy");

  let currentLanguage = localStorage.getItem("language") || "cn";
  let currentBank = localStorage.getItem("currentBank") || "law";
  let questions = JSON.parse(localStorage.getItem("currentQuestions")) || [];
  let mistakes = JSON.parse(localStorage.getItem(`mistakes_${currentBank}`)) || [];
  let completedChapters = JSON.parse(localStorage.getItem(`completedChapters_${currentBank}`)) || [];

  let currentIndex = 0;
  let correctAnswers = 0;
  let currentChapter = questions[0]?.chapter || 1;

  if (!questions.length) {
    alert("é¢˜åº“åŠ è½½å¤±è´¥");
    window.location.href = "index.html";
    return;
  }

  if (completedChapters.includes(currentChapter)) {
    completedChapters = completedChapters.filter(ch => ch !== currentChapter);
    localStorage.setItem(`completedChapters_${currentBank}`, JSON.stringify(completedChapters));
  }

  function updateLanguageButton() {
    languageSwitch.textContent = currentLanguage === "cn" ? "Switch to English" : "åˆ‡æ¢è‡³ä¸­æ–‡";
  }

  languageSwitch.addEventListener("click", () => {
    currentLanguage = currentLanguage === "cn" ? "en" : "cn";
    localStorage.setItem("language", currentLanguage);
    updateLanguageButton();
    loadQuestion();
  });

  updateLanguageButton();

  function loadQuestion() {
    const q = questions[currentIndex];
    questionText.textContent = currentLanguage === "cn" ? q.question_cn : q.question_en;

    optionsContainer.innerHTML = "";
    q.options.forEach((opt, i) => {
      const btn = document.createElement("button");
      btn.className = "option-btn";
      btn.textContent = currentLanguage === "cn" ? opt.cn : opt.en;
      btn.onclick = () => checkAnswer(i, q.correct);
      optionsContainer.appendChild(btn);
    });

    explanationText.classList.add("hidden");
    nextButton.classList.add("hidden");
    progressText.textContent = `${currentIndex + 1} / ${questions.length}`;
    accuracyText.textContent = `${Math.round((correctAnswers / (currentIndex + 1)) * 100)}%`;
  }

  function checkAnswer(selected, correct) {
    const buttons = document.querySelectorAll(".option-btn");
    buttons.forEach((btn, i) => {
      btn.disabled = true;
      if (i === correct) btn.classList.add("correct");
      if (i === selected && i !== correct) btn.classList.add("wrong");
    });

    const q = questions[currentIndex];

    if (selected === correct) {
      correctAnswers++;
      mistakes = mistakes.filter(m => m.question_en !== q.question_en);
    } else {
      if (!mistakes.some(m => m.question_en === q.question_en)) {
        mistakes.push(q);
      }
    }

    localStorage.setItem(`mistakes_${currentBank}`, JSON.stringify(mistakes));

    explanationText.textContent = currentLanguage === "cn" ? q.explanation_cn : q.explanation_en;
    explanationText.classList.remove("hidden");
    nextButton.classList.remove("hidden");
  }

  nextButton.onclick = () => {
    currentIndex++;
    if (currentIndex < questions.length) {
      loadQuestion();
    } else {
      alert(`ðŸŽ‰ ç« èŠ‚å®Œæˆï¼æ­£ç¡®çŽ‡ ${Math.round((correctAnswers / questions.length) * 100)}%`);
      if (!completedChapters.includes(currentChapter) && mistakes.length === 0) {
        completedChapters.push(currentChapter);
        localStorage.setItem(`completedChapters_${currentBank}`, JSON.stringify(completedChapters));
      }
      window.location.href = "index.html";
    }
  };

  backButton.onclick = () => window.location.href = "index.html";

  loadQuestion();
});
